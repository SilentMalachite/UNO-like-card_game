<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNOé¢¨ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ï¼ˆ8äººå¯¾æˆ¦ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .game-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .setup-screen {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            max-width: 500px;
        }

        .setup-screen h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .player-count {
            margin: 20px 0;
        }

        .player-count label {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .player-count select {
            padding: 8px 12px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
            background: white;
            color: #333;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-width: 1200px;
            width: 100%;
        }

        .player-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            text-align: center;
        }

        .player-info.current-player {
            background: rgba(241, 196, 15, 0.3);
            border: 2px solid #f1c40f;
        }

        .player-info .player-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .player-info .card-count {
            font-size: 1.5em;
            color: #f1c40f;
        }

        .center-area {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 30px 0;
        }

        .deck {
            width: 80px;
            height: 120px;
            background: #2c3e50;
            border: 3px solid #34495e;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
            color: white;
        }

        .deck:hover {
            transform: scale(1.05);
        }

        .discard-pile {
            width: 80px;
            height: 120px;
            border: 3px dashed #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .card {
            width: 80px;
            height: 120px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #fff;
            font-weight: bold;
            font-size: 1.2em;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }

        .card.unplayable {
            opacity: 0.4;
            cursor: not-allowed !important;
            filter: grayscale(50%);
        }

        .card.unplayable:hover {
            transform: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .card.red { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .card.blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .card.green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .card.yellow { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .card.wild { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; }
        .card.wild-draw4 { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; }

        .card .number {
            font-size: 2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .card .action {
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            text-align: center;
        }

        .card .color-name {
            font-size: 0.7em;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .current-hand {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1000px;
            margin: 20px 0;
        }

        .game-controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 15px 30px;
            border-radius: 25px;
            margin: 15px 0;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }

        .turn-indicator {
            font-size: 1.8em;
            margin: 20px 0;
            padding: 15px 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .winner {
            font-size: 2em;
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            width: 200px;
        }

        .hidden {
            display: none !important;
        }

        .direction-indicator {
            font-size: 1.5em;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .arrow {
            font-size: 2em;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <h1 class="game-title">ğŸ´ UNOé¢¨ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ï¼ˆå¤šäººæ•°å¯¾æˆ¦ï¼‰</h1>
    
    <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
    <div id="setupScreen" class="setup-screen">
        <h2>ã‚²ãƒ¼ãƒ è¨­å®š</h2>
        
        <div class="player-count">
            <label for="playerCount">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°:</label>
            <select id="playerCount">
                <option value="2">2äºº</option>
                <option value="3">3äºº</option>
                <option value="4">4äºº</option>
                <option value="5">5äºº</option>
                <option value="6">6äºº</option>
                <option value="7">7äºº</option>
                <option value="8" selected>8äºº</option>
            </select>
        </div>

        <div id="playerNames"></div>
        
        <button class="btn btn-success" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="gameScreen" class="hidden">
        <div class="players-grid" id="playersGrid"></div>
        
        <div class="turn-indicator" id="turnIndicator"></div>
        
        <div class="direction-indicator" id="directionIndicator">
            ã‚²ãƒ¼ãƒ é€²è¡Œæ–¹å‘: <span class="arrow" id="directionArrow">â†’</span>
        </div>

        <div class="center-area">
            <div class="deck" id="deck" onclick="drawCard()">
                å±±æœ­<br><span id="deckCount">0</span>
            </div>
            <div class="discard-pile" id="discardPile"></div>
        </div>

        <div class="game-controls">
            <button class="btn btn-primary" onclick="showSetup()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
            <button class="btn btn-secondary" id="drawBtn" onclick="drawCard()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
            <button class="btn btn-secondary" id="endTurnBtn" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
            <button class="btn btn-success" id="unoBtn" onclick="callUno()" style="display: none;">UNO!</button>
        </div>

        <div id="message" class="message" style="display: none;"></div>

        <div class="current-hand" id="currentHand"></div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            players: [],
            deck: [],
            discardPile: [],
            currentPlayerIndex: 0,
            direction: 1, // 1: æ™‚è¨ˆå›ã‚Š, -1: åæ™‚è¨ˆå›ã‚Š
            gameOver: false,
            canDraw: true,
            hasDrawn: false,
            unoCallRequired: {}, // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’ã‚­ãƒ¼ã¨ã—ã¦UNOã‚³ãƒ¼ãƒ«ãŒå¿…è¦ã‹ã©ã†ã‹
            pendingDraw: 0, // ç©ã¿é‡ãªã£ãŸãƒ‰ãƒ­ãƒ¼æ•°
            canStack: false // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã®ç©ã¿é‡ã­ãŒå¯èƒ½ã‹
        };

        // ã‚«ãƒ¼ãƒ‰ã®è‰²ã¨æ•°å­—
        const colors = ['red', 'blue', 'green', 'yellow'];
        const colorNames = { red: 'èµ¤', blue: 'é’', green: 'ç·‘', yellow: 'é»„' };
        const numbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
        const actionCards = ['skip', 'reverse', 'draw2'];
        const actionNames = { skip: 'ã‚¹ã‚­ãƒƒãƒ—', reverse: 'ãƒªãƒãƒ¼ã‚¹', draw2: 'ãƒ‰ãƒ­ãƒ¼2' };
        const wildCardNames = { wild: 'ãƒ¯ã‚¤ãƒ«ãƒ‰', 'wild-draw4': 'ãƒ¯ã‚¤ãƒ«ãƒ‰+4' };

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã®åˆæœŸåŒ–
        function initSetup() {
            const playerCountSelect = document.getElementById('playerCount');
            playerCountSelect.addEventListener('change', updatePlayerNameInputs);
            updatePlayerNameInputs();
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
        function updatePlayerNameInputs() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const container = document.getElementById('playerNames');
            container.innerHTML = '';

            for (let i = 1; i <= playerCount; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                inputGroup.innerHTML = `
                    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i} ã®åå‰:</label>
                    <input type="text" id="player${i}Name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i}" maxlength="15">
                `;
                container.appendChild(inputGroup);
            }
        }

        // ãƒ‡ãƒƒã‚­ã‚’ä½œæˆ
        function createDeck() {
            const deck = [];
            
            // å„è‰²ã«0-9ã®æ•°å­—ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆ0ã¯1æšã€1-9ã¯2æšãšã¤ï¼‰
            colors.forEach(color => {
                // 0ã®ã‚«ãƒ¼ãƒ‰ã¯å„è‰²1æšã®ã¿
                deck.push({ type: 'number', color, number: 0 });
                // 1-9ã®ã‚«ãƒ¼ãƒ‰ã¯å„è‰²2æšãšã¤
                for (let number = 1; number <= 9; number++) {
                    deck.push({ type: 'number', color, number });
                    deck.push({ type: 'number', color, number });
                }
                
                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’å„è‰²2æšãšã¤è¿½åŠ 
                actionCards.forEach(action => {
                    deck.push({ type: 'action', color, action });
                    deck.push({ type: 'action', color, action });
                });
            });
            
            // ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆå„4æšï¼‰
            for (let i = 0; i < 4; i++) {
                deck.push({ type: 'wild', action: 'wild' });
            }
            for (let i = 0; i < 4; i++) {
                deck.push({ type: 'wild', action: 'wild-draw4' });
            }
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ‡ãƒƒã‚­ã®ç·æ•°ã‚’ç¢ºèª
            console.log(`ãƒ‡ãƒƒã‚­ä½œæˆå®Œäº†: ç·${deck.length}æš`);
            
            return shuffleDeck(deck);
        }

        // ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’æç”»
        function renderCard(card, clickHandler = null, isClickable = true) {
            const cardEl = document.createElement('div');
            let cardClass = 'card ';
            
            if (card.type === 'wild') {
                cardClass += card.action;
            } else {
                cardClass += card.color;
            }
            
            cardEl.className = cardClass;
            if (!isClickable) cardEl.style.cursor = 'default';
            
            let cardContent;
            if (card.type === 'number') {
                cardContent = `
                    <div class="number">${card.number}</div>
                    <div class="color-name">${colorNames[card.color]}</div>
                `;
            } else if (card.type === 'action') {
                cardContent = `
                    <div class="action">${actionNames[card.action]}</div>
                    <div class="color-name">${colorNames[card.color]}</div>
                `;
            } else if (card.type === 'wild') {
                cardContent = `
                    <div class="action">${wildCardNames[card.action]}</div>
                    <div class="color-name">å…¨è‰²å¯¾å¿œ</div>
                `;
            }
            
            cardEl.innerHTML = cardContent;
            
            if (clickHandler && isClickable) {
                cardEl.onclick = clickHandler;
            }
            
            return cardEl;
        }

        // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚’è¡¨ç¤º
        function renderCurrentHand() {
            const handEl = document.getElementById('currentHand');
            handEl.innerHTML = '';
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            currentPlayer.hand.forEach((card, index) => {
                const isPlayable = canPlayCard(card);
                const cardEl = renderCard(card, isPlayable ? () => playCard(index) : null, isPlayable);
                
                if (!isPlayable) {
                    cardEl.classList.add('unplayable');
                    cardEl.title = 'ã“ã®ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“';
                }
                
                handEl.appendChild(cardEl);
            });
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        function renderPlayersGrid() {
            const gridEl = document.getElementById('playersGrid');
            gridEl.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerEl = document.createElement('div');
                playerEl.className = 'player-info';
                if (index === gameState.currentPlayerIndex) {
                    playerEl.classList.add('current-player');
                }
                
                playerEl.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="card-count">${player.hand.length}æš</div>
                `;
                
                gridEl.appendChild(playerEl);
            });
        }

        // æ¨ã¦æœ­ã‚’è¡¨ç¤º
        function renderDiscardPile() {
            const discardEl = document.getElementById('discardPile');
            discardEl.innerHTML = '';
            
            if (gameState.discardPile.length > 0) {
                const topCard = gameState.discardPile[gameState.discardPile.length - 1];
                const cardEl = renderCard(topCard, null, false);
                discardEl.appendChild(cardEl);
            }
        }

        // ã‚«ãƒ¼ãƒ‰ãŒãƒ—ãƒ¬ã‚¤å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canPlayCard(card) {
            if (gameState.discardPile.length === 0) return true;
            
            const topCard = gameState.discardPile[gameState.discardPile.length - 1];
            
            // ãƒ‰ãƒ­ãƒ¼ãŒç©ã¿é‡ãªã£ã¦ã„ã‚‹å ´åˆã®ã‚¹ã‚¿ãƒƒã‚¯ãƒ«ãƒ¼ãƒ«
            if (gameState.pendingDraw > 0 && gameState.canStack) {
                // ãƒ‰ãƒ­ãƒ¼2ã§ãƒ‰ãƒ­ãƒ¼2ã‚’ç©ã¿é‡ã­ã‚‰ã‚Œã‚‹
                if (card.type === 'action' && card.action === 'draw2' && topCard.type === 'action' && topCard.action === 'draw2') {
                    return true;
                }
                // ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ‰ãƒ­ãƒ¼4ã§ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ‰ãƒ­ãƒ¼4ã‚’ç©ã¿é‡ã­ã‚‰ã‚Œã‚‹
                if (card.type === 'wild' && card.action === 'wild-draw4' && topCard.type === 'wild' && topCard.action === 'wild-draw4') {
                    return true;
                }
                // ãã‚Œä»¥å¤–ã®ã‚«ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ã‚¤ä¸å¯
                return false;
            }
            
            // ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¯å¸¸ã«ãƒ—ãƒ¬ã‚¤å¯èƒ½
            if (card.type === 'wild') return true;
            
            // è‰²ãŒä¸€è‡´ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®è‰²ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚å«ã‚€ï¼‰
            if (card.color === topCard.color || (topCard.chosenColor && card.color === topCard.chosenColor)) return true;
            
            // æ•°å­—ã‚«ãƒ¼ãƒ‰åŒå£«ã§æ•°å­—ãŒä¸€è‡´
            if (card.type === 'number' && topCard.type === 'number' && card.number === topCard.number) return true;
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰åŒå£«ã§ç¨®é¡ãŒä¸€è‡´
            if (card.type === 'action' && topCard.type === 'action' && card.action === topCard.action) return true;
            
            return false;
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤
        function playCard(cardIndex) {
            if (gameState.gameOver) return;
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const card = currentPlayer.hand[cardIndex];
            
            if (!canPlayCard(card)) {
                showMessage('ãã®ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“ï¼', 2000);
                return;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã‹ã‚‰æ¨ã¦æœ­ã«ç§»å‹•
            currentPlayer.hand.splice(cardIndex, 1);
            gameState.discardPile.push(card);
            gameState.canDraw = true;
            gameState.hasDrawn = false;
            
            // å‹åˆ©ãƒã‚§ãƒƒã‚¯
            if (currentPlayer.hand.length === 0) {
                endGame(currentPlayer.name);
                return;
            }
            
            // UNOã‚³ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ‰‹æœ­ãŒ1æšã«ãªã£ãŸæ™‚ï¼‰
            if (currentPlayer.hand.length === 1) {
                gameState.unoCallRequired[gameState.currentPlayerIndex] = true;
                showMessage(`${currentPlayer.name}ã•ã‚“ã¯UNOã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼`, 3000);
                // UNOãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('unoBtn').style.display = 'inline-block';
            }
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’å®Ÿè¡Œ
            if (card.type === 'action') {
                executeActionCard(card);
            } else if (card.type === 'wild') {
                executeWildCard(card);
            } else {
                // é€šå¸¸ã®æ•°å­—ã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€²ã‚€
                nextPlayer();
            }
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã‹ã‚‰å¼•ã
        function drawCard() {
            if (gameState.gameOver) return;
            
            if (gameState.deck.length === 0) {
                const reshuffled = reshuffleDeck();
                if (!reshuffled || gameState.deck.length === 0) {
                    showMessage('å±±æœ­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™', 3000);
                    endGame('å¼•ãåˆ†ã‘');
                    return;
                }
            }
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const drawnCard = gameState.deck.pop();
            currentPlayer.hand.push(drawnCard);
            gameState.hasDrawn = true;
            
            showMessage(`${currentPlayer.name}ãŒã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã—ãŸ`, 1500);
            
            updateDisplay();
        }

        // å±±æœ­ã‚’å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function reshuffleDeck() {
            if (gameState.discardPile.length <= 1) {
                showMessage('ãƒªã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§ãã¾ã›ã‚“ã€‚æ¨ã¦æœ­ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 2000);
                return false;
            }
            
            // æ¨ã¦æœ­ã®ä¸€ç•ªä¸Šä»¥å¤–ã‚’å±±æœ­ã«æˆ»ã™
            const topCard = gameState.discardPile.pop();
            const cardsToShuffle = [...gameState.discardPile];
            gameState.discardPile = [topCard];
            gameState.deck = shuffleDeck(cardsToShuffle);
            
            showMessage(`æ¨ã¦æœ­${cardsToShuffle.length}æšã‚’å±±æœ­ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ`, 2000);
            return true;
        }

        // ã‚¿ãƒ¼ãƒ³çµ‚äº†
        function endTurn() {
            if (gameState.gameOver) return;
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const hasPlayableCard = currentPlayer.hand.some(card => canPlayCard(card));
            
            // ãƒ—ãƒ¬ã‚¤å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™ã‹å¼•ãã‹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            if (!gameState.hasDrawn && gameState.canDraw && hasPlayableCard) {
                showMessage('ãƒ—ãƒ¬ã‚¤å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™ã‹ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦ãã ã•ã„', 2000);
                return;
            }
            
            // ãƒ—ãƒ¬ã‚¤å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã€ã¾ãŸã¯ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸå ´åˆã¯ã‚¿ãƒ¼ãƒ³çµ‚äº†å¯èƒ½
            nextPlayer();
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’å®Ÿè¡Œ
        function executeActionCard(card) {
            switch (card.action) {
                case 'skip':
                    showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒã‚¹ã‚­ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¾ã—ãŸï¼æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`, 2500);
                    nextPlayer(); // é€šå¸¸ã®æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€²ã‚€
                    nextPlayer(); // ã•ã‚‰ã«ã‚‚ã†ä¸€äººé£›ã°ã™
                    break;
                
                case 'reverse':
                    gameState.direction *= -1;
                    showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒãƒªãƒãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¾ã—ãŸï¼é †ç•ªãŒé€†ã«ãªã‚Šã¾ã™`, 2500);
                    nextPlayer();
                    break;
                
                case 'draw2':
                    // ã‚¹ã‚¿ãƒƒã‚¯ãƒ«ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯
                    if (gameState.pendingDraw > 0 && gameState.canStack) {
                        gameState.pendingDraw += 2;
                        showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒãƒ‰ãƒ­ãƒ¼2ã‚’ç©ã¿é‡ã­ã¾ã—ãŸï¼ç·ãƒ‰ãƒ­ãƒ¼æ•°: ${gameState.pendingDraw}æš`, 2500);
                    } else {
                        gameState.pendingDraw = 2;
                        gameState.canStack = true;
                        showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒãƒ‰ãƒ­ãƒ¼2ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¾ã—ãŸï¼`, 2500);
                    }
                    nextPlayer();
                    // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ‰ãƒ­ãƒ¼2ã‚’å‡ºã›ãªã„å ´åˆã®å‡¦ç†ã¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«è¡Œã†
                    break;
            }
        }
        
        // ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’å®Ÿè¡Œ
        function executeWildCard(card) {
            // è‰²é¸æŠã®å‡¦ç†
            const chosenColor = prompt('è‰²ã‚’é¸æŠã—ã¦ãã ã•ã„:\n1: èµ¤ (red)\n2: é’ (blue)\n3: ç·‘ (green)\n4: é»„ (yellow)', '1');
            
            let colorChoice;
            switch (chosenColor) {
                case '1': colorChoice = 'red'; break;
                case '2': colorChoice = 'blue'; break;
                case '3': colorChoice = 'green'; break;
                case '4': colorChoice = 'yellow'; break;
                default: colorChoice = 'red'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯èµ¤
            }
            
            // æ¨ã¦æœ­ã®ä¸€ç•ªä¸Šã®ã‚«ãƒ¼ãƒ‰ã«é¸æŠã—ãŸè‰²ã‚’è¿½åŠ 
            const topCard = gameState.discardPile[gameState.discardPile.length - 1];
            topCard.chosenColor = colorChoice;
            
            if (card.action === 'wild') {
                showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¾ã—ãŸï¼æ¬¡ã®è‰²ã¯${colorNames[colorChoice]}ã§ã™`, 2500);
                nextPlayer();
            } else if (card.action === 'wild-draw4') {
                // ã‚¹ã‚¿ãƒƒã‚¯ãƒ«ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯
                if (gameState.pendingDraw > 0 && gameState.canStack) {
                    gameState.pendingDraw += 4;
                    showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ‰ãƒ­ãƒ¼4ã‚’ç©ã¿é‡ã­ã¾ã—ãŸï¼ç·ãƒ‰ãƒ­ãƒ¼æ•°: ${gameState.pendingDraw}æšã€‚æ¬¡ã®è‰²ã¯${colorNames[colorChoice]}ã§ã™`, 3000);
                } else {
                    gameState.pendingDraw = 4;
                    gameState.canStack = true;
                    showMessage(`${gameState.players[gameState.currentPlayerIndex].name}ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ‰ãƒ­ãƒ¼4ã‚’å‡ºã—ã¾ã—ãŸï¼æ¬¡ã®è‰²ã¯${colorNames[colorChoice]}ã§ã™`, 3000);
                }
                nextPlayer();
            }
        }
        
        // UNOã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹é–¢æ•°
        function callUno() {
            const currentPlayerIndex = gameState.currentPlayerIndex;
            if (gameState.unoCallRequired[currentPlayerIndex]) {
                delete gameState.unoCallRequired[currentPlayerIndex];
                showMessage(`${gameState.players[currentPlayerIndex].name}ãŒUNOã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼`, 2000);
                document.getElementById('unoBtn').style.display = 'none';
            }
        }
        
        // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€²ã‚€
        function nextPlayer() {
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒUNOã‚³ãƒ¼ãƒ«ã‚’å¿˜ã‚ŒãŸå ´åˆã®ãƒšãƒŠãƒ«ãƒ†ã‚£
            const currentPlayerIndex = gameState.currentPlayerIndex;
            if (gameState.unoCallRequired[currentPlayerIndex]) {
                const currentPlayer = gameState.players[currentPlayerIndex];
                showMessage(`${currentPlayer.name}ãŒUNOã‚³ãƒ¼ãƒ«ã‚’å¿˜ã‚Œã¾ã—ãŸï¼ãƒšãƒŠãƒ«ãƒ†ã‚£ã§2æšå¼•ãã¾ã™`, 3000);
                
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã§2æšå¼•ã
                for (let i = 0; i < 2; i++) {
                    if (gameState.deck.length === 0) {
                        const reshuffled = reshuffleDeck();
                        if (!reshuffled) break;
                    }
                    if (gameState.deck.length > 0) {
                        currentPlayer.hand.push(gameState.deck.pop());
                    }
                }
                
                delete gameState.unoCallRequired[currentPlayerIndex];
            }
            
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + gameState.direction + gameState.players.length) % gameState.players.length;
            gameState.canDraw = true;
            gameState.hasDrawn = false;
            
            // UNOãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('unoBtn').style.display = 'none';
            
            // ãƒ‰ãƒ­ãƒ¼ã‚«ãƒ¼ãƒ‰ã®ç©ã¿é‡ã­å‡¦ç†
            const newCurrentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (gameState.pendingDraw > 0) {
                // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¹ã‚¿ãƒƒã‚¯å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const topCard = gameState.discardPile[gameState.discardPile.length - 1];
                let canStackCard = false;
                
                if (topCard.type === 'action' && topCard.action === 'draw2') {
                    canStackCard = newCurrentPlayer.hand.some(card => card.type === 'action' && card.action === 'draw2');
                } else if (topCard.type === 'wild' && topCard.action === 'wild-draw4') {
                    canStackCard = newCurrentPlayer.hand.some(card => card.type === 'wild' && card.action === 'wild-draw4');
                }
                
                if (!canStackCard || !gameState.canStack) {
                    // ã‚¹ã‚¿ãƒƒã‚¯ã§ããªã„ã®ã§ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
                    for (let i = 0; i < gameState.pendingDraw; i++) {
                        if (gameState.deck.length === 0) {
                            const reshuffled = reshuffleDeck();
                            if (!reshuffled) break;
                        }
                        if (gameState.deck.length > 0) {
                            newCurrentPlayer.hand.push(gameState.deck.pop());
                        }
                    }
                    showMessage(`${newCurrentPlayer.name}ãŒ${gameState.pendingDraw}æšå¼•ãã¾ã—ãŸã€‚ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`, 2500);
                    gameState.pendingDraw = 0;
                    gameState.canStack = false;
                    // ã‚‚ã†ä¸€åº¦æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€²ã‚€
                    gameState.currentPlayerIndex = (gameState.currentPlayerIndex + gameState.direction + gameState.players.length) % gameState.players.length;
                }
            }
            
            updateDisplay();
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame(winnerName) {
            gameState.gameOver = true;
            
            if (winnerName === 'å¼•ãåˆ†ã‘') {
                document.getElementById('turnIndicator').innerHTML = `<div class="winner">ğŸ¤ å¼•ãåˆ†ã‘ã§ã™</div>`;
                showMessage('å±±æœ­ãŒè¶³ã‚Šãªããªã‚Šã¾ã—ãŸã€‚æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 5000);
            } else {
                document.getElementById('turnIndicator').innerHTML = `<div class="winner">ğŸ‰ ${winnerName}ã•ã‚“ã®å‹åˆ©ï¼</div>`;
                showMessage('ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æ–°ã—ã„ã‚²ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å†åº¦ãƒ—ãƒ¬ã‚¤ã—ã¦ãã ã•ã„', 5000);
            }
            
            // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('drawBtn').disabled = true;
            document.getElementById('endTurnBtn').disabled = true;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showMessage(text, duration = 3000) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, duration);
        }

        // ç”»é¢ã‚’æ›´æ–°
        function updateDisplay() {
            renderCurrentHand();
            renderPlayersGrid();
            renderDiscardPile();
            
            document.getElementById('deckCount').textContent = gameState.deck.length;
            
            if (!gameState.gameOver) {
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                document.getElementById('turnIndicator').textContent = `${currentPlayer.name}ã•ã‚“ã®ã‚¿ãƒ¼ãƒ³ã§ã™`;
            }
            
            // æ–¹å‘ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
            document.getElementById('directionArrow').textContent = gameState.direction === 1 ? 'â†’' : 'â†';
            
            document.getElementById('drawBtn').disabled = gameState.gameOver || gameState.hasDrawn;
            document.getElementById('endTurnBtn').disabled = gameState.gameOver;
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’åé›†
            gameState.players = [];
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`player${i}Name`).value.trim() || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i}`;
                gameState.players.push({
                    name: name,
                    hand: []
                });
            }
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            gameState.deck = createDeck();
            gameState.discardPile = [];
            gameState.currentPlayerIndex = 0;
            gameState.direction = 1;
            gameState.gameOver = false;
            gameState.canDraw = true;
            gameState.hasDrawn = false;
            gameState.unoCallRequired = {};
            gameState.pendingDraw = 0;
            gameState.canStack = false;
            
            // æ‰‹æœ­ã‚’é…ã‚‹ï¼ˆå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«7æšãšã¤ï¼‰
            for (let i = 0; i < 7; i++) {
                gameState.players.forEach(player => {
                    if (gameState.deck.length > 0) {
                        player.hand.push(gameState.deck.pop());
                    }
                });
            }
            
            // æœ€åˆã®æ¨ã¦æœ­ã‚’ç½®ãï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚„ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¯é¿ã‘ã‚‹ï¼‰
            let firstCard;
            do {
                if (gameState.deck.length === 0) break;
                firstCard = gameState.deck.pop();
            } while (firstCard && (firstCard.type === 'action' || firstCard.type === 'wild'));
            
            if (firstCard) {
                gameState.discardPile.push(firstCard);
            } else if (gameState.deck.length > 0) {
                // ã‚‚ã—ã‚‚æ•°å­—ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
                gameState.discardPile.push(gameState.deck.pop());
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateDisplay();
            showMessage('ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼', 2000);
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹
        function showSetup() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
        }

        // åˆæœŸåŒ–
        initSetup();
    </script>
</body>
</html>